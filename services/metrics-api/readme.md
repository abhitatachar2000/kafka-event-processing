## Metrics API Service

The metrics api service is responsible for providing a REST API to query the real-time metrics generated by the analytics service.
The service reads the metrics events from the `metrics.output` topic and maintains an in-memory store of the metrics for quick retrieval.

The topic was created with 6 partitions and replication-factor of 1 (since we have only one broker). You can find the topic creation configuration [here](https://github.com/abhitatachar2000/kafka-event-processing/blob/main/docs/topics.md).

#### What This Service Does

1. Consumes metrics events from Kafka
2. Maintains in-memory storage of metrics
3. Provides REST endpoints to query metrics

#### What It Does NOT Do

1. Generate metrics
2. Perform analytics computations
3. Persist metrics to external storage

### Configuration

The consumer is created with this configuration:

```yaml
spring:
  kafka:
    bootstrap-servers: ${SPRING_KAFKA_BOOTSTRAP_SERVERS:localhost:9092}
    consumer:
      group-id: metrics-api-group
      auto-offset-reset: earliest
      enable-auto-commit: false
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: com.kafkaevents.events
        partition.assignment.strategy: org.apache.kafka.clients.consumer.RoundRobinAssignor
```

- The consumer belongs to `metrics-api-group`. The service maintains 6 concurrent consumers, each reading from one partition of the `metrics.output`.
- The `enable-auto-commit` is set to false. We only want to commit the offset once we have processed the event being read in the current round. The manual commit config is managed in the [KafkaConsumerConfig.java](https://github.com/abhitatachar2000/kafka-event-processing/blob/main/services/metrics-api/src/main/java/com/kafkaevents/metrics/service/KafkaConsumerConfig.java).

### Learning:

The use of in-memory storage allows for fast retrieval of metrics, but it's not suitable for production environments where persistence and scalability are required. In a real-world scenario, metrics would be stored in a database or time-series database for historical analysis.

The service can be started by executing:

```bash
mvn spring-boot:run
```

The service runs on port 8009.

To query metrics, make a GET request to the `/api/v1/metrics` endpoint with a query parameter `metricName`. Supported metric names are:

- `ordersPerProductPerDay`: Returns orders per product per day
- `revenuePerProductPerDay`: Returns revenue per product per day
- `outOfStockProducts`: Returns products that are out of stock with timestamps

Example request:

```bash
curl -X GET "http://localhost:8009/api/v1/metrics?metricName=ordersPerProductPerDay"
```